{% extends "base.html" %}

{% block title %}{{ sighting.common_name }} - {{ config.site_title }}{% endblock %}

{% block content %}
<div class="container">
    <article class="sighting-detail">
        <header class="sighting-header">
            <h1>{{ sighting.common_name }}{% if sighting.scientific_name %} <span class="scientific-name">(<em>{{ sighting.scientific_name }}</em>)</span>{% endif %}</h1>
        </header>

        {% if sighting.images %}
        <div class="sighting-gallery">
            <!-- Main image display -->
            <figure class="gallery-main">
                <img id="main-image"
                     src="{{ image_url }}/web/{{ sighting.images[0].filename }}"
                     alt="{{ sighting.common_name }}{% if sighting.images[0].caption %} - {{ sighting.images[0].caption }}{% endif %}"
                     class="lightbox-trigger"
                     data-full="{{ image_url }}/full/{{ sighting.images[0].filename }}">
                {% if sighting.images[0].caption %}
                <figcaption id="main-caption">{{ sighting.images[0].caption }}</figcaption>
                {% else %}
                <figcaption id="main-caption"></figcaption>
                {% endif %}
            </figure>

            <!-- Thumbnail strip (only if more than 1 image) -->
            {% if sighting.images | length > 1 %}
            <div class="gallery-thumbs">
                {% for image in sighting.images %}
                <button class="gallery-thumb{% if loop.first %} active{% endif %}"
                        data-web="{{ image_url }}/web/{{ image.filename }}"
                        data-full="{{ image_url }}/full/{{ image.filename }}"
                        data-caption="{{ image.caption or '' }}">
                    <img src="{{ image_url }}/thumb/{{ image.filename }}"
                         alt="{{ sighting.common_name }} - image {{ loop.index }}">
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="lightbox" role="dialog" aria-label="Image viewer">
            <button class="lightbox-close" aria-label="Close image viewer">&times;</button>
            <img class="lightbox-image" src="" alt="{{ sighting.common_name }}">
        </div>
        {% endif %}

        <div class="sighting-meta">
            <div class="meta-group">
                <h3>Details</h3>
                <dl>
                    <dt>ID</dt>
                    <dd>{{ sighting.id }}</dd>

                    <dt>Category</dt>
                    <dd>{{ sighting.category | title }}</dd>

                    {% if sighting.size_mm %}
                    <dt>Size</dt>
                    <dd>~{{ sighting.size_mm }}mm <span class="size-badge size-{{ sighting.size_mm | size_category | lower }}">{{ sighting.size_mm | size_category }}</span></dd>
                    {% endif %}

                    <dt>Season</dt>
                    <dd>{{ sighting.season | title }}</dd>

                    <dt>Observed</dt>
                    <dd>{{ sighting.captured_at | date }}</dd>

                    {% if sighting.time_of_day %}
                    <dt>Time of Day</dt>
                    <dd>{{ sighting.time_of_day | title }}</dd>
                    {% endif %}
                </dl>
            </div>

            {% if sighting.tags %}
            <div class="meta-group">
                <h3>Tags</h3>
                <div class="tags-list">
                    {% for tag in sighting.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if sighting.id_certainty %}
            <div class="meta-group">
                <h3>ID Certainty</h3>
                <span class="certainty-badge certainty-{{ sighting.id_certainty | lower }}">{{ sighting.id_certainty | upper }}</span>
            </div>
            {% endif %}

            {% if sighting.weather %}
            <div class="meta-group">
                <h3>Weather</h3>
                <dl>
                    {% if sighting.weather.temp_max_c %}
                    <dt>Temperature</dt>
                    <dd>{{ sighting.weather.temp_min_c }}째C - {{ sighting.weather.temp_max_c }}째C</dd>
                    {% endif %}

                    <dt>Conditions</dt>
                    <dd>{{ sighting.weather.conditions }}</dd>

                    {% if sighting.weather.humidity_percent %}
                    <dt>Humidity</dt>
                    <dd>{{ sighting.weather.humidity_percent | int }}%</dd>
                    {% endif %}

                    {% if sighting.weather.precipitation_mm %}
                    <dt>Precipitation</dt>
                    <dd>{{ sighting.weather.precipitation_mm }} mm</dd>
                    {% endif %}

                    {% if sighting.weather.wind_speed_kmh %}
                    <dt>Wind</dt>
                    <dd>{{ sighting.weather.wind_speed_kmh | int }} km/h ({{ sighting.weather.wind_direction_deg }}째)</dd>
                    {% endif %}

                    {% if sighting.weather.pressure_hpa %}
                    <dt>Pressure</dt>
                    <dd>{{ sighting.weather.pressure_hpa | int }} hPa</dd>
                    {% endif %}

                    {% if sighting.weather.soil_temp_c %}
                    <dt>Soil Temp</dt>
                    <dd>{{ sighting.weather.soil_temp_c }}째C</dd>
                    {% endif %}

                    {% if sighting.weather.uv_index %}
                    <dt>UV Index</dt>
                    <dd>{{ sighting.weather.uv_index }}</dd>
                    {% endif %}
                </dl>
            </div>
            {% endif %}

            {% if sighting.celestial %}
            <div class="meta-group">
                <h3>Celestial</h3>
                <dl>
                    <dt>Moon Phase</dt>
                    <dd>{{ sighting.celestial.moon_phase }} ({{ (sighting.celestial.moon_illumination * 100) | int }}%)</dd>

                    <dt>Sunrise</dt>
                    <dd>{{ sighting.celestial.sunrise }}</dd>

                    <dt>Sunset</dt>
                    <dd>{{ sighting.celestial.sunset }}</dd>
                </dl>
            </div>
            {% endif %}
        </div>

        {% if sighting.notes %}
        <div class="sighting-notes">
            <h3>Notes</h3>
            <p>{{ sighting.notes }}</p>
        </div>
        {% endif %}

        {% if timeline and timeline_max > 0 %}
        <div class="observation-timeline">
            <h3>Observations of {{ sighting.common_name }}</h3>
            <div class="timeline-chart">
                <div class="timeline-y-axis">
                    {% for i in range(7, 0, -1) %}
                    <span class="y-tick">{{ i }}</span>
                    {% endfor %}
                </div>
                <div class="timeline-main">
                    <div class="timeline-bars">
                        {% for count in timeline %}
                        <div class="timeline-bar" style="height: {{ (count / 7 * 100) }}%;" title="Week {{ loop.index }}: {{ count }} observation{{ 's' if count != 1 else '' }}">
                        </div>
                        {% endfor %}
                    </div>
                    <div class="timeline-months">
                        {% for m in timeline_months %}
                        <span class="month-label" style="left: {{ (m.week / 52 * 100) }}%;">{{ m.label }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <nav class="sighting-nav">
            <div class="nav-prev">
                {% if next_sighting %}
                <a href="{{ base_url }}/sightings/{{ next_sighting.id }}.html" id="nav-prev">&larr; {{ next_sighting.common_name }}</a>
                {% endif %}
            </div>
            <div class="nav-center">
                <a href="{{ base_url }}/browse.html">Browse All</a>
            </div>
            <div class="nav-next">
                {% if prev_sighting %}
                <a href="{{ base_url }}/sightings/{{ prev_sighting.id }}.html" id="nav-next">{{ prev_sighting.common_name }} &rarr;</a>
                {% endif %}
            </div>
        </nav>
    </article>
</div>

<script>
(function() {
    // Gallery thumbnail switching
    const mainImage = document.getElementById('main-image');
    const mainCaption = document.getElementById('main-caption');
    const thumbs = document.querySelectorAll('.gallery-thumb');

    thumbs.forEach(thumb => {
        thumb.addEventListener('click', () => {
            // Update main image
            mainImage.src = thumb.dataset.web;
            mainImage.dataset.full = thumb.dataset.full;
            mainCaption.textContent = thumb.dataset.caption;

            // Update active state
            thumbs.forEach(t => t.classList.remove('active'));
            thumb.classList.add('active');
        });
    });

    // Lightbox
    const lightbox = document.getElementById('lightbox');
    if (!lightbox) return;

    const lightboxImg = lightbox.querySelector('.lightbox-image');
    const closeBtn = lightbox.querySelector('.lightbox-close');
    let isZoomed = false;

    if (mainImage) {
        mainImage.style.cursor = 'pointer';
        mainImage.addEventListener('click', () => {
            lightboxImg.src = mainImage.dataset.full;
            lightboxImg.alt = mainImage.alt;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
            isZoomed = false;
            lightboxImg.style.transform = '';
            lightboxImg.style.maxWidth = '98vw';
            lightboxImg.style.maxHeight = '98vh';
        });
    }

    // Double-tap to zoom
    let lastTap = 0;
    lightboxImg.addEventListener('click', (e) => {
        const now = Date.now();
        if (now - lastTap < 300) {
            // Double tap
            if (isZoomed) {
                lightboxImg.style.transform = '';
                lightboxImg.style.maxWidth = '98vw';
                lightboxImg.style.maxHeight = '98vh';
                lightboxImg.style.cursor = 'zoom-in';
            } else {
                lightboxImg.style.maxWidth = 'none';
                lightboxImg.style.maxHeight = 'none';
                lightboxImg.style.cursor = 'zoom-out';
            }
            isZoomed = !isZoomed;
            e.stopPropagation();
        }
        lastTap = now;
    });

    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        isZoomed = false;
    }

    closeBtn.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) closeLightbox();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeLightbox();
    });
})();

// Keyboard navigation for prev/next sighting
document.addEventListener('keydown', (e) => {
    if (document.getElementById('lightbox')?.classList.contains('active')) return;
    if (e.key === 'ArrowLeft') {
        const prev = document.getElementById('nav-prev');
        if (prev) prev.click();
    } else if (e.key === 'ArrowRight') {
        const next = document.getElementById('nav-next');
        if (next) next.click();
    }
});
</script>
{% endblock %}
